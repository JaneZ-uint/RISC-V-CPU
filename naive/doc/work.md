# 调试记录 (Debug Log)

## 2026-01-01: 修复无限循环与 JAL 跳转偏移问题

### 问题描述
在运行 1 到 100 累加的测试程序时，仿真陷入无限循环。
- **现象**: 寄存器 `x2` (循环计数器) 的值超过了 101 (日志显示达到 400+)，且程序没有在 `beq` 指令处退出循环。
- **预期**: 当 `x2` 达到 101 时，`beq x2, x3, end` (PC: 0x10) 应该跳转到结束位置。

### 排查过程
1. **日志分析**:
   - 观察 `vvp` 输出的 trace，发现 `x2` 正常累加，但 `beq` 指令似乎未生效或被跳过。
   - 怀疑是循环末尾的 `jal` 指令跳转目标错误，导致程序跳转到了 `beq` 之后的指令 (如 `0x14`)，从而跳过了循环终止条件的检查。

2. **指令编码检查**:
   - 出错的指令: `jal x0, loop` (位于 `0x1c`，目标 `0x10`)。
   - 原始编码: `0xffbff06f`。
   - 偏移量计算: 目标地址 `0x10` - 当前 PC `0x1c` = `-12`。
   - 修正编码: `0xff5ff06f` (对应立即数 -12 的 J-type 编码)。

3. **仿真配置调整**:
   - 修改 `naive/sim/testbench.v`，将超时时间从 `#2000` 增加到 `#50000`，以确保有足够的时间跑完 100 次循环。

### 修复方案
1. **更新 ROM 生成脚本**: 修改 `naive/sim/gen_rom.py` 中的机器码。
2. **重新生成 ROM**: 运行 `python3 naive/sim/gen_rom.py` 更新 `inst_rom.data`。
3. **重新编译仿真**: 运行 `iverilog` 和 `vvp`。

### 验证结果
- **最终状态**: 仿真成功结束 (遇到 `ECALL`)。
- **结果检查**: 寄存器 `x1` 的最终值为 `5050` (1+2+...+100 的正确结果)。
- **耗时**: 6165000 ticks。

---
